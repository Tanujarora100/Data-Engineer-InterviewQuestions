WITH CTE AS(
    SELECT
        C.NAME,
        C.CUSTOMER_ID,
        O.ORDER_ID,
        O.ORDER_DATE,
        ROW_NUMBER() OVER(
            PARTITION BY C.CUSTOMER_ID
            ORDER BY
                O.ORDER_DATE DESC
        ) AS TOTAL_ORDERS
    FROM
        CUSTOMERS AS C
        JOIN ORDERS AS O ON C.CUSTOMER_ID = O.CUSTOMER_ID
)
SELECT
    NAME AS CUSTOMER_NAME,
    CUSTOMER_ID,
    ORDER_ID,
    ORDER_DATE
FROM
    CTE
WHERE
    TOTAL_ORDERS <= 3
ORDER BY
    CUSTOMER_NAME,
    CUSTOMER_ID,
    ORDER_DATE DESC